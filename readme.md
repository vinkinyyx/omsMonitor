# 智能日志巡检管家 (Smart Log Inspection Agent)

这是一个基于 Python 的高度自动化的巡检项目，旨在通过无头浏览器自动抓取“华瑭接口”等后台管理系统中的大批量日志，将非白名单的报错记录提取、去重，并形成易读的 Excel / Txt 报告。系统同时深度集成了**飞书**与**企业微信**机器人，提供一站式、对话式的值守方案。

## 🎯 核心功能与需求矩阵

### 1. 强力抓取引擎 (`main.py`)
- **API 级无损拦截**：全面拦截底层带有 `report/refresh` 的数据请求，智能扩充默认的 10 条分页参数至 `1000` 条，保证日志提取全景无遗漏。
- **多维度清洗过滤**：
  - **白名单机制**：配置忽略数组（如“未查询到XX”），消除无效报错噪音。
  - **时效区间**：自动筛选指定的起止日期（或通过 IM 动态传入）。
  - **状态与节点**：精准下钻（成功=0、失败=1或全量=2），锁定特定集成流（支持多达40余个业务流名匹配）。
  - **交叉去重**：对同一时间段、同一报文、同一报错仅保留最具代表性的首条记录。
- **三重抗脆弱设计（防挂引擎）**：
  - 加载超时自动生成 `error_screenshot.png` 快照与 DOM 副本。
  - API 抓包失败时极速切换为“页面 DOM 解析”保底方案。
  - 即便当天业务风平浪静，系统也会生成包含“今日无报错”文本的空文件结构，保证通知闭环。

### 2. 对话式驱动：飞书向导版 (`lark_server.py`)
- 不再盲目触发，内置了会话级状态机提供**多轮问答式导航**。
- 回复“巡检”即刻启动。依次引导用户输入：**开始日期 ➔ 结束日期 ➔ 排查状态 ➔ 集成流选择**。
- 支持各种不规范输入的自动正则格式化（如 `20260226` -> `2026-02-26`）。
- 具备 3 次防呆容错提示机制，选项以数字菜单热载投递。

### 3. 系统底层生命周期图谱（逻辑执行闭环）
系统从触发到导出的完整闭环动作严格遵循以下流线：
1. **身份破壁区 (Auth & Navigation)**
   - 拉起基于 Chromium 内核的无痕 Playwright 实例（无头模式以极大节约性能）。
   - 载入登录界面 -> 定位账号密码框 -> 模拟人为打字注入配置项密码 -> 等待跳转并定位左侧边栏至“华瑭接口集成流日志”。
2. **战术伪装与诱导区 (Parameter Setup & Hack)**
   - 捕获右侧表面板，挂载无底线网络监听器 `page.route`，等待猎物出没。
   - 界面上依据给定的（或用户动态传进的）时间与选项条件，清空原输入框内容后强制 `Enter` 刷新触发前端 React/Vue 组件受控绑定。
   - 最关键：通过 JS 主动寻找页脚分页选框并从前端强制设置为“1000”，同时网络监听器针对被拦截到的接口 URL 中的 `currPageSize` 直接进行正则表达式级别的暴力改写 `1000` 放行，实行强制“双保险满载”。
3. **强制去重与提纯降噪区 (Purity Pipeline)**
   - 点击查询，一旦探测到包含 `data` 主树的 JSON 包并获取到高达千条的响应后，脱离游览器，开始进入纯数据洗盘。
   - **剔除杂质项**：剔除了展示表头主键和内部关联编码列，只留下了时间、消息和参数报文。
   - **白名单蒸发**：逐行遍历“消息”列，遇预先定好的“无此订单”此类的安全提醒文字时，连根拔起将该条目整行抛弃。
   - **华夏专杀**：系统自带强过滤规则，但凡集成流包含“华夏”字眼的报错直接将其全部物理抹除屏蔽。
   - **时间精准裁剪**：通过 `Pandas` 对每一行的字符串时间标切割裁剪，并基于用户配置或下发的日期筛出合法数据。
   - **去重策略 A (强力压制)**：当行记录中的“集成流”标记以及“请求报文”出现多条完全一样的情况（某个失败子系统疯狂退回重试），依据创建时间倒序排查，全局针对同一系统报文只保留“时间最新的一条”。
4. **去 0 斩草除根与制板收尾 (Deduplication & Export)**
   - **去 0 行动**：经过前置去重，如果某条流重试最终成功（保留了最新的一条状态为0的数据覆盖了之前的1），将在这一步迎来“清道夫”。系统锁定【状态】列，将状态无论是 `0` 还是 `0.0` 或者是带空格的全盘物理抹杀。
   - **去重策略 B (相似文本合并)**：对于依然存活的高危记录，拿“集成流”和“消息提醒”作为对账体，引入正则遮罩了动态 ID 等随机数字后，再度归纳合并同类项，最大程度缩减海量重复报错现象对查阅者的折磨。
   - **制表落盘**：进行最终的数据时间降序美化展示，调用流将 DataFrame 的脏数据一键生成无格式 `txt` 和给上级领导查阅的 `xlsx` 精致报表。如果没报错就出全白提醒表。

### 4. 即时指令：企微快捷版 (`wechat_server.py`)
- 短平快的命令反馈，企微员工对应用发送“开始巡检”，立刻拉起静默巡扫。

### 4. 全链路透明与追溯
- **IM 气泡追播**：抓取引擎产生的 `[PROGRESS]` 标签将会“0 延迟、跨进程”突破缓冲限制，秒级推送回您的聊天框中，呈现执行步骤与拦截战况。
- **双轨文档自动派送**：爬取完成后，无论是生成的 `error_logs.xlsx` 还是 `error_logs.txt` 均打包上云，直接发至用户私聊。
- **沙盒文件归档**：在服务器本目录自动生成 `logs/` 文件夹，每次触发基于时间戳保存完整的脱水日志。

---

## 🛠️ 环境依赖与配置向导

### 1. 基础环境
```bash
pip install -r requirements.txt
playwright install chromium
```

### 2. 核心配置文件 (`config.json`)
根目录下的该配置文件是驱动一切的基石。您可以随意增补您的流水线代号及白名单语句：
```json
{
    "url": "https://oms.htdkgroup.com/#/",
    "username": "你的账号",
    "password": "密码",
    "integration_flow": "所有",
    "integration_flows": [
         "所有",
         "T1001_采购订单",
         "T1020_获取BIDUI"
    ],
    "whitelist": [
        "未查询到采购订单信息"
    ],
    "wechat": { ...配置省略... },
    "lark": { ...配置省略... }
}
```
> *注：上述的 `integration_flows` 就是飞书中会被提取呈现出来的选项菜单。*

---

## 🚀 启动与运行

您可以选择直接在本机命令台测试核心引擎，或者挂载后台 Webhook 服务迎接微信和飞书的唤醒请求。

### 方式 A：单次本地运行（不发消息）
```bash
python main.py
```
> 您可以在这调试并观察本地立刻下发的 `error_logs.xlsx` 和运行时长。

### 方式 B：启动飞书机器人（默认 8081 端口）
```bash
python lark_server.py
```
- 请去飞书开放平台配置好消息接收的 Request URL (记得经过内网穿透或者使用公网地址并加上 `/lark` 路径)。
- 在飞书随便发一句**“巡检”**体验问答。

### 方式 C：启动企微应用（默认 8080 端口）
```bash
python wechat_server.py
```
- 同理配置企微后管中心指向。私聊应用发送**“开始巡检”**。
